<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å®‰å…¨è¯ä»¶æ°´å°åŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #00e060; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --text-sub: #8e8e93; --border: #38383a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .page { display: none; flex-direction: column; width: 100%; height: 100%; box-sizing: border-box; position: absolute; top: 0; left: 0; background: var(--bg); z-index: 1; }
        .page.active { display: flex; z-index: 10; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--bg); border-bottom: 0.5px solid var(--border); height: 44px; z-index: 20; }
        .back-btn { background: none; border: none; color: var(--text); font-size: 16px; display: flex; align-items: center; cursor: pointer; padding: 0; }
        .back-btn span { font-size: 20px; margin-right: 4px; }
        .header-title { font-size: 17px; font-weight: 600; }
        
        /* é€šç”¨å¸ƒå±€ */
        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .center-content { align-items: center; justify-content: center; }
        
        /* é¡µé¢1ï¼šè¾“å…¥ */
        .preview-box { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 24px; min-height: 100px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .watermark-text { font-size: 18px; line-height: 1.5; color: var(--text); word-break: break-all; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 24px; }
        .tag { background: #2c2c2e; color: var(--text); border: none; padding: 8px 16px; border-radius: 18px; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .tag.active { background: var(--primary); color: #000; font-weight: 600; }
        .custom-input { background: var(--card); border: 1px solid var(--border); color: var(--text); width: 100%; padding: 12px; border-radius: 10px; font-size: 16px; box-sizing: border-box; margin-bottom: 20px; }
        
        .btn-area { margin-top: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        .btn { border: none; border-radius: 12px; padding: 16px; font-size: 17px; font-weight: 600; cursor: pointer; text-align: center; width: 100%; box-sizing: border-box; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-secondary { background: #2c2c2e; color: var(--text); }
        .btn-danger { background: #ff3b30; color: #fff; }
        .btn-blue { background: #007aff; color: #fff; }
        
        /* é¡µé¢2ï¼šæ‹ç…§/é¢„è§ˆ */
        .viewport { width: 100%; flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        .viewport video, .viewport canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        .overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .controls { background: var(--bg); padding: 20px; border-top: 0.5px solid var(--border); }
        .density-options { display: flex; background: var(--card); border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .density-btn { flex: 1; background: none; border: none; color: var(--text-sub); padding: 8px; border-radius: 8px; font-size: 14px; }
        .density-btn.active { background: #636366; color: #fff; font-weight: 600; }
        
        .shutter-btn { width: 72px; height: 72px; border-radius: 50%; background: #fff; border: 4px solid rgba(255,255,255,0.3); margin: 0 auto; display: block; cursor: pointer; }
        
        /* é¡µé¢3ï¼šç»“æœ */
        .result-view { width: 100%; max-height: 60vh; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative; background: var(--card); display: flex; align-items: center; justify-content: center; }
        .result-view canvas { max-width: 100%; max-height: 100%; }
        .rotate-btn { position: absolute; bottom: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff; border: none; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* è¾…åŠ© */
        input[type="file"] { display: none; }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#fff; display:flex; align-items:center; justify-content:center; z-index:99; display:none; }
    </style>
</head>
<body>

<div class="loading" id="loading">å¤„ç†ä¸­...</div>

<div id="page1" class="page active">
    <div class="header">
        <div style="width:24px;"></div>
        <div class="header-title">æ°´å°è®¾ç½®</div>
        <div style="width:24px;"></div>
    </div>
    <div class="content">
        <div class="preview-box">
            <div class="watermark-text" id="textPreview">è¯¥è¯ä»¶ä»…ä¾›åŠç† <span style="color:var(--primary)">æŸé¡¹ä¸šåŠ¡</span> ä½¿ç”¨ï¼Œä»–ç”¨æ— æ³•å¾‹æ•ˆåŠ›</div>
        </div>
        
        <div style="font-size:14px; color:var(--text-sub); margin-bottom:10px;">é€‰æ‹©ç”¨é€”æ¨¡æ¿ï¼š</div>
        <div class="tag-container">
            <button class="tag" onclick="selectTag('ä»…ä¾›åŠç†ç§Ÿæˆ¿ä¸šåŠ¡ä½¿ç”¨')">ğŸ  ç§Ÿæˆ¿</button>
            <button class="tag" onclick="selectTag('ä»…ä¾›åŠç†æ‰‹æœºä¸šåŠ¡ä½¿ç”¨')">ğŸ“± æ‰‹æœºä¸šåŠ¡</button>
            <button class="tag" onclick="selectTag('ä»…ä¾›èº«ä»½æ ¸éªŒä½¿ç”¨')">ğŸ†” èº«ä»½æ ¸éªŒ</button>
            <button class="tag" onclick="selectTag('ä»…ä¾›åŠç†é“¶è¡Œå¡ä½¿ç”¨')">ğŸ’³ é“¶è¡ŒåŠç†</button>
            <button class="tag" onclick="selectTag('ä»…ä¾›å…¥èŒåŠç†ä½¿ç”¨')">ğŸ’¼ å…¥èŒ</button>
            <button class="tag active" onclick="selectTag('')">âœï¸ è‡ªå®šä¹‰</button>
        </div>

        <input type="text" id="customInput" class="custom-input" placeholder="åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰æ°´å°å†…å®¹..." oninput="updateCustomText()">

        <div class="btn-area">
            <button class="btn btn-primary" onclick="startCameraMode()">ğŸ“· æ‹æ‘„ç…§ç‰‡</button>
            <button class="btn btn-secondary" onclick="startUploadMode()">ğŸ–¼ï¸ ä¸Šä¼ ç…§ç‰‡</button>
        </div>
        <input type="file" id="fileInput" accept="image/*">
    </div>
</div>

<div id="page2" class="page">
    <div class="header">
        <button class="back-btn" onclick="goPage(1)"><span>&lt;</span> è¿”å›</button>
        <div class="header-title" id="page2Title">æ‹æ‘„</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="viewport" id="viewport">
        <video id="video" autoplay playsinline style="display:none;"></video>
        <canvas id="imgCanvas" style="display:none;"></canvas>
        <canvas id="overlayCanvas" class="overlay-canvas"></canvas>
    </div>

    <div class="controls">
        <div class="density-options">
            <button class="density-btn" onclick="setDensity('sparse')">ç¨€ç–</button>
            <button class="density-btn active" onclick="setDensity('normal')">æ­£å¸¸</button>
            <button class="density-btn" onclick="setDensity('dense')">å¯†é›†</button>
        </div>
        
        <button id="shutterBtn" class="shutter-btn" onclick="takePhoto()"></button>
        <button id="nextBtn" class="btn btn-primary" style="display:none;" onclick="processImage()">ä¸‹ä¸€æ­¥</button>
    </div>
</div>

<div id="page3" class="page">
    <div class="header">
        <button class="back-btn" onclick="goPage(2)"><span>&lt;</span> è¿”å›</button>
        <div class="header-title">å¯¼å‡ºå›¾ç‰‡</div>
        <div style="width:40px;"></div>
    </div>
    <div class="content center-content">
        <div class="result-view">
            <canvas id="finalCanvas"></canvas>
            <button class="rotate-btn" onclick="rotateImage()">ğŸ”„</button>
        </div>
        
        <div class="btn-area" style="width:100%;">
            <button class="btn btn-primary" onclick="saveImage()">â¬‡ï¸ ä¿å­˜å›¾ç‰‡</button>
            <button class="btn btn-danger" onclick="exportPDF()">ğŸ“„ å¯¼å‡º PDF</button>
            <button class="btn btn-secondary" onclick="goPage(1)">ğŸ  å›åˆ°é¦–é¡µ</button>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    const { jsPDF } = window.jspdf;
    let currentText = "ä»…ä¾›åŠç†ä¸šåŠ¡ä½¿ç”¨ï¼Œä»–ç”¨æ— æ•ˆ";
    let mode = 'camera'; // 'camera' or 'upload'
    let density = 'normal'; // sparse, normal, dense
    let rotationAngle = 0;
    let originalImg = null; // ä¸Šä¼ æˆ–æ‹æ‘„çš„åŸå§‹å›¾
    let videoStream = null;

    // é¢„è®¾å‚æ•°: é—´è·(px), é€æ˜åº¦(0-1)
    const PRESETS = {
        sparse: { gap: 300, alpha: 0.25, color: '#808080' },
        normal: { gap: 200, alpha: 0.20, color: '#808080' },
        dense:  { gap: 120, alpha: 0.15, color: '#808080' }
    };

    // DOM å…ƒç´ 
    const els = {
        page1: document.getElementById('page1'),
        page2: document.getElementById('page2'),
        page3: document.getElementById('page3'),
        textPreview: document.getElementById('textPreview'),
        customInput: document.getElementById('customInput'),
        video: document.getElementById('video'),
        imgCanvas: document.getElementById('imgCanvas'),
        overlayCanvas: document.getElementById('overlayCanvas'),
        finalCanvas: document.getElementById('finalCanvas'),
        fileInput: document.getElementById('fileInput'),
        loading: document.getElementById('loading')
    };

    // --- é¡µé¢åˆ‡æ¢ ---
    function goPage(n) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        els[`page${n}`].classList.add('active');
        
        if (n === 1) stopCamera();
        if (n === 2) {
            rotationAngle = 0; // é‡ç½®æ—‹è½¬
            if (mode === 'camera') startCamera();
            drawWatermarkOverlay(); // ç»˜åˆ¶æ°´å°å±‚
        }
    }

    // --- é¡µé¢1 é€»è¾‘ ---
    function selectTag(txt) {
        document.querySelectorAll('.tag').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if (txt === '') {
            // è‡ªå®šä¹‰æ¨¡å¼
            els.customInput.focus();
            updateCustomText();
        } else {
            currentText = txt;
            els.customInput.value = '';
            els.textPreview.innerText = txt;
        }
    }

    function updateCustomText() {
        const val = els.customInput.value.trim();
        currentText = val || "ä»…ä¾›åŠç†ä¸šåŠ¡ä½¿ç”¨ï¼Œä»–ç”¨æ— æ•ˆ";
        els.textPreview.innerText = currentText;
    }

    function startCameraMode() {
        mode = 'camera';
        document.getElementById('page2Title').innerText = "æ‹æ‘„è¯ä»¶";
        document.getElementById('shutterBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';
        els.video.style.display = 'block';
        els.imgCanvas.style.display = 'none';
        goPage(2);
    }

    function startUploadMode() {
        els.fileInput.click();
    }

    els.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        mode = 'upload';
        document.getElementById('page2Title').innerText = "å›¾ç‰‡é¢„è§ˆ";
        document.getElementById('shutterBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'block';
        els.video.style.display = 'none';
        els.imgCanvas.style.display = 'block';
        els.loading.style.display = 'flex';

        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                originalImg = img;
                drawUploadPreview();
                els.loading.style.display = 'none';
                goPage(2);
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    });

    // --- é¡µé¢2 é€»è¾‘ ---
    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            els.video.srcObject = videoStream;
            // ç­‰å¾…è§†é¢‘å°ºå¯¸åŠ è½½ä»¥è°ƒæ•´æ°´å°å±‚
            els.video.onloadedmetadata = () => {
                drawWatermarkOverlay(); 
            };
        } catch (err) {
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨ä¸Šä¼ åŠŸèƒ½ã€‚");
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
    }

    function setDensity(type) {
        density = type;
        document.querySelectorAll('.density-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        drawWatermarkOverlay();
    }

    // ç»˜åˆ¶ä¸Šä¼ é¢„è§ˆå›¾ (ä¿æŒæ¯”ä¾‹é€‚é…å±å¹•)
    function drawUploadPreview() {
        if (!originalImg) return;
        const cvs = els.imgCanvas;
        const parent = document.getElementById('viewport');
        const mw = parent.clientWidth;
        const mh = parent.clientHeight;
        
        // è®¡ç®—ç¼©æ”¾
        const scale = Math.min(mw / originalImg.width, mh / originalImg.height);
        cvs.width = originalImg.width * scale;
        cvs.height = originalImg.height * scale;
        const ctx = cvs.getContext('2d');
        ctx.drawImage(originalImg, 0, 0, cvs.width, cvs.height);
        
        // è°ƒæ•´æ°´å°å±‚å¤§å°åŒ¹é…å›¾ç‰‡
        els.overlayCanvas.width = cvs.width;
        els.overlayCanvas.height = cvs.height;
        drawWatermarkOverlay();
    }

    // ç»˜åˆ¶æ°´å°è¦†ç›–å±‚ (é€šç”¨)
    function drawWatermarkOverlay() {
        // å¦‚æœæ˜¯ç›¸æœºæ¨¡å¼ï¼Œç”»å¸ƒå¤§å°è®¾ä¸ºå¯è§†åŒºåŸŸå¤§å°
        // å¦‚æœæ˜¯ä¸Šä¼ æ¨¡å¼ï¼Œç”»å¸ƒå¤§å°å·²ç»è®¾ä¸ºå›¾ç‰‡å¤§å°
        const cvs = els.overlayCanvas;
        const ctx = cvs.getContext('2d');
        
        if (mode === 'camera') {
            const vp = document.getElementById('viewport');
            cvs.width = vp.clientWidth;
            cvs.height = vp.clientHeight;
        }

        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const conf = PRESETS[density];
        ctx.font = "bold 24px sans-serif";
        ctx.fillStyle = conf.color;
        ctx.globalAlpha = conf.alpha;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // æ—‹è½¬æ°´å°
        ctx.save();
        // ç§»åŠ¨åˆ°ä¸­å¿ƒæ—‹è½¬
        ctx.translate(cvs.width/2, cvs.height/2);
        ctx.rotate(-45 * Math.PI / 180);
        ctx.translate(-cvs.width, -cvs.height); // ç§»å›å·¦ä¸Šè§’ä»¥ä¾¿å¹³é“º

        const diag = Math.sqrt(cvs.width**2 + cvs.height**2) * 2; // è¦†ç›–è¶³å¤Ÿå¤§çš„åŒºåŸŸ
        for (let y = 0; y < diag; y += conf.gap) {
            for (let x = 0; x < diag; x += (ctx.measureText(currentText).width + 60)) {
                ctx.fillText(currentText, x, y);
            }
        }
        ctx.restore();
    }

    // æ‹ç…§å¤„ç†
    function takePhoto() {
        const v = els.video;
        const cvs = document.createElement('canvas');
        cvs.width = v.videoWidth;
        cvs.height = v.videoHeight;
        cvs.getContext('2d').drawImage(v, 0, 0);
        
        const img = new Image();
        img.onload = () => {
            originalImg = img;
            processImage();
        };
        img.src = cvs.toDataURL('image/jpeg');
    }

    // å¤„ç†å¹¶è¿›å…¥ç»“æœé¡µ
    function processImage() {
        stopCamera();
        generateFinalResult();
        goPage(3);
    }

    // --- é¡µé¢3 é€»è¾‘ ---
    function rotateImage() {
        rotationAngle = (rotationAngle + 90) % 360;
        generateFinalResult();
    }

    function generateFinalResult() {
        if (!originalImg) return;
        const cvs = els.finalCanvas;
        const ctx = cvs.getContext('2d');
        
        // å¤„ç†æ—‹è½¬é€»è¾‘
        if (rotationAngle === 90 || rotationAngle === 270) {
            cvs.width = originalImg.height;
            cvs.height = originalImg.width;
        } else {
            cvs.width = originalImg.width;
            cvs.height = originalImg.height;
        }

        ctx.save();
        // ç§»åŠ¨åŸç‚¹åˆ°ä¸­å¿ƒè¿›è¡Œå›¾ç‰‡æ—‹è½¬
        ctx.translate(cvs.width/2, cvs.height/2);
        ctx.rotate(rotationAngle * Math.PI / 180);
        if (rotationAngle === 90 || rotationAngle === 270) {
             ctx.drawImage(originalImg, -originalImg.height/2, -originalImg.width/2);
        } else {
             ctx.drawImage(originalImg, -originalImg.width/2, -originalImg.height/2);
        }
        ctx.restore();

        // ç»˜åˆ¶æ°´å° (åœ¨æ—‹è½¬åçš„ç”»å¸ƒä¸Šå†å ä¸€å±‚)
        const conf = PRESETS[density];
        // æ”¾å¤§å­—ä½“é€‚åº”åŸå›¾åˆ†è¾¨ç‡ (å‡è®¾åŸå›¾è¾ƒå¤§ï¼Œè¿™é‡ŒæŒ‰æ¯”ä¾‹æ”¾å¤§å­—ä½“)
        const scale = Math.max(cvs.width, cvs.height) / 1000; 
        const fontSize = Math.max(24, 30 * scale);
        
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.fillStyle = conf.color;
        ctx.globalAlpha = conf.alpha;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // å†æ¬¡æ—‹è½¬åæ ‡ç³»ç”¨äºç»˜åˆ¶å€¾æ–œæ°´å°
        const diag = Math.sqrt(cvs.width**2 + cvs.height**2);
        ctx.save();
        ctx.translate(cvs.width/2, cvs.height/2);
        ctx.rotate(-45 * Math.PI / 180);
        ctx.translate(-diag, -diag);

        const gap = conf.gap * (scale > 1 ? scale : 1); // é—´è·ä¹Ÿéšåˆ†è¾¨ç‡ç¼©æ”¾
        
        for (let y = 0; y < diag * 2; y += gap) {
            for (let x = 0; x < diag * 2; x += (ctx.measureText(currentText).width + (60 * scale))) {
                ctx.fillText(currentText, x, y);
            }
        }
        ctx.restore();
    }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'æ°´å°è¯ä»¶_' + Date.now() + '.jpg';
        link.href = els.finalCanvas.toDataURL('image/jpeg', 0.95);
        link.click();
    }

    function exportPDF() {
        const cvs = els.finalCanvas;
        const imgData = cvs.toDataURL('image/jpeg', 0.95);
        const orientation = cvs.width > cvs.height ? 'l' : 'p';
        
        // åˆ›å»ºPDFï¼Œå•ä½è®¾ä¸ºåƒç´ ï¼Œå°ºå¯¸ä¸å›¾ç‰‡ä¸€è‡´
        const doc = new jsPDF({
            orientation: orientation,
            unit: 'px',
            format: [cvs.width, cvs.height]
        });
        
        doc.addImage(imgData, 'JPEG', 0, 0, cvs.width, cvs.height);
        doc.save('æ°´å°è¯ä»¶_' + Date.now() + '.pdf');
    }
</script>
</body>
</html>
