<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å®‰å…¨è¯ä»¶æ°´å°åŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojMDA3YmZmIj48cGF0aCBkPSJNMjU2IDMyYTMyIDMyIDAgMCAwLTMyIDMydjY0SDY0YTMyIDMyIDAgMCAwLTMyIDMydjI1NmEzMiAzMiAwIDAgMCAzMiAzMmgyNTZhMzIgMzIgMCAwIDAgMzItMzJWMzIwSDQ0OGEzMiAzMiAwIDAgMCAzMi0zMlY5NmEzMiAzMiAwIDAgMC0zMi0zMmgtNjRWNjRhMzIgMzIgMCAwIDAtMzItMzJ6bTAgOTZoMTI4djE2MEgyNTZ6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjojMDA3YmZmIj48cGF0aCBkPSJNMjU2IDMyYTMyIDMyIDAgMCAwLTMyIDMydjY0SDY0YTMyIDMyIDAgMCAwLTMyIDMydjI1NmEzMiAzMiAwIDAgMCAzMiAzMmgyNTZhMzIgMzIgMCAwIDAgMzItMzJWMzIwSDQ0OGEzMiAzMiAwIDAgMCAzMi0zMlY5NmEzMiAzMiAwIDAgMC0zMi0zMmgtNjRWNjRhMzIgMzIgMCAwIDAtMzItMzJ6bTAgOTZoMTI4djE2MEgyNTZ6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; padding: 20px; max-width: 600px; margin: 0 auto; color: #333; -webkit-tap-highlight-color: transparent; }
        h2 { text-align: center; color: #333; font-weight: 600; margin-bottom: 20px; }
        .container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-box { border: 2px dashed #cbd5e1; padding: 40px 20px; text-align: center; border-radius: 12px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .upload-box:hover { border-color: #007bff; background: #eff6ff; }
        .upload-icon { font-size: 32px; color: #94a3b8; margin-bottom: 10px; display: block;}
        input[type="file"] { display: none; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls { display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-size: 13px; color: #64748b; margin-bottom: 6px; font-weight: 500; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        input[type="color"] { width: 100%; height: 40px; padding: 2px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        input[type="range"] { width: 100%; accent-color: #007bff; }
        
        /* ç”»å¸ƒé¢„è§ˆ */
        canvas { width: 100%; height: auto; border-radius: 8px; border: 1px solid #e2e8f0; display: none; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* æŒ‰é’®ç»„ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { display: flex; align-items: center; justify-content: center; padding: 14px; color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; text-decoration: none; box-sizing: border-box; transition: 0.2s; }
        .btn-primary { background: #007bff; }
        .btn-primary:active { background: #0056b3; transform: scale(0.98); }
        .btn-danger { background: #ef4444; }
        .btn-danger:active { background: #dc2626; transform: scale(0.98); }
        
        .tips { font-size: 13px; color: #856404; margin-top: 20px; background: #fff3cd; padding: 15px; border-radius: 8px; display: none; line-height: 1.6; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading { display: none; text-align: center; margin: 20px 0; color: #666; }
    </style>
</head>
<body>

    <h2>ğŸ›¡ï¸ å®‰å…¨è¯ä»¶æ°´å°åŠ©æ‰‹</h2>

    <div class="container">
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <span class="upload-icon">ğŸ“·</span>
            <p style="margin: 0; color: #64748b;">ç‚¹å‡»æ‹ç…§ æˆ– é€‰æ‹©å›¾ç‰‡</p>
        </div>
        <input type="file" id="fileInput" accept="image/*">

        <div class="loading" id="loadingText">å¤„ç†ä¸­...</div>

        <canvas id="previewCanvas"></canvas>

        <div class="controls" id="controlsArea">
            <div class="control-group" style="grid-column: span 2;">
                <label>æ°´å°å†…å®¹ (å»ºè®®å¡«å†™çœŸå®ç”¨é€”)</label>
                <input type="text" id="textInput" value="æ­¤è¯ä»¶ä»…ä¾›åŠç† X ä¸šåŠ¡ä½¿ç”¨ï¼Œä»–ç”¨æ— æ•ˆ">
            </div>
            <div class="control-group">
                <label>å­—ä½“å¤§å° (<span id="sizeVal">28</span>)</label>
                <input type="range" id="fontSize" min="15" max="80" value="28">
            </div>
            <div class="control-group">
                <label>é€æ˜åº¦ (<span id="alphaVal">0.18</span>)</label>
                <input type="range" id="alpha" min="0.05" max="1" step="0.01" value="0.18">
            </div>
            <div class="control-group">
                <label>æ—‹è½¬è§’åº¦</label>
                <input type="range" id="rotate" min="-90" max="90" value="-25">
            </div>
            <div class="control-group">
                <label>é¢œè‰² (æ¨èç°è‰²)</label>
                <input type="color" id="color" value="#9CA3AF">
            </div>
            <div class="control-group" style="grid-column: span 2;">
                <label>å¯†é›†ç¨‹åº¦</label>
                <input type="range" id="gap" min="100" max="500" step="20" value="180">
            </div>
        </div>

        <div id="actionButtons" style="display: none;">
            <div class="btn-group">
                <a id="downloadBtn" class="btn btn-primary">ğŸ’¾ ä¿å­˜å›¾ç‰‡</a>
                <button onclick="exportPDF()" class="btn btn-danger">ğŸ“„ å¯¼å‡º PDF</button>
            </div>
            <div class="tips">
                ğŸ’¡ <b>æŠ— OCR å¹²æ‰°æŠ€å·§ï¼š</b><br>
                1. <b>é€æ˜åº¦</b> ä¿æŒåœ¨ 0.15 - 0.25 ä¹‹é—´ï¼ˆå½“å‰ <span id="tipAlpha">0.18</span>ï¼‰ã€‚<br>
                2. <b>é¢œè‰²</b> ä¿æŒæµ…ç°è‰²ï¼Œä¸è¦ç”¨çº¯é»‘ã€‚<br>
                3. æ°´å°æ–‡å­—è¶Šå¯†é›†ï¼Œè¶Šå¹²æ‰°æœºå™¨è¯†åˆ«ã€‚<br>
                * æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œå›¾ç‰‡ä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf; // åˆå§‹åŒ– PDF åº“
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const controlsArea = document.getElementById('controlsArea');
        const actionButtons = document.getElementById('actionButtons');
        const downloadBtn = document.getElementById('downloadBtn');
        const tips = document.querySelector('.tips');
        const loadingText = document.getElementById('loadingText');

        let originalImage = null;

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            loadingText.style.display = 'block';
            controlsArea.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    initCanvas();
                    loadingText.style.display = 'none';
                    controlsArea.style.display = 'grid';
                    canvas.style.display = 'block';
                    actionButtons.style.display = 'block';
                    tips.style.display = 'block';
                    drawWatermark();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function initCanvas() {
            // é€‚å½“å‹ç¼©æ˜¾ç¤ºå°ºå¯¸ï¼Œä½†ä¿å­˜æ—¶ä¼šç”¨è¾ƒé«˜è´¨é‡
            const maxWidth = 1000; 
            let width = originalImage.width;
            let height = originalImage.height;

            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
        }

        function drawWatermark() {
            if (!originalImage) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç»˜åˆ¶åŸå›¾
            ctx.globalAlpha = 1;
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            // è·å–å‚æ•°
            const text = document.getElementById('textInput').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const alpha = parseFloat(document.getElementById('alpha').value);
            const rotate = parseInt(document.getElementById('rotate').value);
            const color = document.getElementById('color').value;
            const gap = parseInt(document.getElementById('gap').value);

            // æ›´æ–°æ•°å€¼æ˜¾ç¤º
            document.getElementById('sizeVal').innerText = fontSize;
            document.getElementById('alphaVal').innerText = alpha;
            document.getElementById('tipAlpha').innerText = alpha;

            // ç»˜åˆ¶æ°´å°
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.fillStyle = color;
            ctx.globalAlpha = alpha;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            const diag = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
            
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotate * Math.PI / 180);
            ctx.translate(-diag, -diag);

            for (let y = 0; y < diag * 2; y += gap) {
                for (let x = 0; x < diag * 2; x += (ctx.measureText(text).width + 60)) {
                    ctx.fillText(text, x, y);
                }
            }
            ctx.restore();

            // æ›´æ–°ä¸‹è½½æŒ‰é’®é“¾æ¥
            downloadBtn.href = canvas.toDataURL("image/jpeg", 0.92);
            downloadBtn.download = "æ°´å°è¯ä»¶_" + new Date().getTime() + ".jpg";
        }

        // PDF å¯¼å‡ºåŠŸèƒ½
        function exportPDF() {
            if (!originalImage) return;
            
            // åˆ›å»º PDFï¼Œæ–¹å‘æ ¹æ®å›¾ç‰‡é•¿å®½æ¯”è‡ªåŠ¨å†³å®š
            const orientation = canvas.width > canvas.height ? 'l' : 'p';
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'px',
                format: [canvas.width, canvas.height] // è®© PDF é¡µé¢å¤§å°ç­‰äºå›¾ç‰‡å¤§å°
            });

            const imgData = canvas.toDataURL("image/jpeg", 0.92);
            doc.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
            doc.save("æ°´å°è¯ä»¶_" + new Date().getTime() + ".pdf");
        }

        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', drawWatermark);
        });
    </script>
</body>
</html>